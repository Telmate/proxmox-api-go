package proxmox

import (
	"testing"

	"github.com/stretchr/testify/require"
)

func Test_RawGuestResources_Get(t *testing.T) {
	tests := []struct {
		name   string
		input  RawGuestResources
		output []GuestResource
	}{
		{name: "CpuCores",
			input:  RawGuestResources{map[string]any{"maxcpu": float64(10)}},
			output: []GuestResource{{CpuCores: 10}}},
		{name: "CpuUsage",
			input:  RawGuestResources{map[string]any{"cpu": float64(3.141592653589793)}},
			output: []GuestResource{{CpuUsage: 3.141592653589793}}},
		{name: "DiskReadTotal",
			input:  RawGuestResources{map[string]any{"diskread": float64(1637428)}},
			output: []GuestResource{{DiskReadTotal: 1637428}}},
		{name: "DiskSizeInBytes",
			input:  RawGuestResources{map[string]any{"maxdisk": float64(8589934592)}},
			output: []GuestResource{{DiskSizeInBytes: 8589934592}}},
		{name: "DiskUsedInBytes",
			input:  RawGuestResources{map[string]any{"disk": float64(1073741824)}},
			output: []GuestResource{{DiskUsedInBytes: 1073741824}}},
		{name: "DiskWriteTotal",
			input:  RawGuestResources{map[string]any{"diskwrite": float64(1690811)}},
			output: []GuestResource{{DiskWriteTotal: 1690811}}},
		{name: "HaState",
			input:  RawGuestResources{map[string]any{"hastate": "started"}},
			output: []GuestResource{{HaState: "started"}}},
		{name: "Id",
			input:  RawGuestResources{map[string]any{"vmid": float64(100)}},
			output: []GuestResource{{ID: 100}}},
		{name: "MemoryTotalInBytes",
			input:  RawGuestResources{map[string]any{"maxmem": float64(2147483648)}},
			output: []GuestResource{{MemoryTotalInBytes: 2147483648}}},
		{name: "MemoryUsedInBytes",
			input:  RawGuestResources{map[string]any{"mem": float64(1048576)}},
			output: []GuestResource{{MemoryUsedInBytes: 1048576}}},
		{name: "Name",
			input:  RawGuestResources{map[string]any{"name": "test-vm1"}},
			output: []GuestResource{{Name: "test-vm1"}}},
		{name: "NetworkIn",
			input:  RawGuestResources{map[string]any{"netin": float64(23884639)}},
			output: []GuestResource{{NetworkIn: 23884639}}},
		{name: "NetworkOut",
			input:  RawGuestResources{map[string]any{"netout": float64(1000123465987)}},
			output: []GuestResource{{NetworkOut: 1000123465987}}},
		{name: "Node",
			input:  RawGuestResources{map[string]any{"node": "pve1"}},
			output: []GuestResource{{Node: "pve1"}}},
		{name: "Status",
			input:  RawGuestResources{map[string]any{"status": "running"}},
			output: []GuestResource{{Status: PowerStateRunning}}},
		{name: "Tags",
			input:  RawGuestResources{map[string]any{"tags": "tag1;tag2;tag3"}},
			output: []GuestResource{{Tags: []Tag{"tag1", "tag2", "tag3"}}}},
		{name: "Template",
			input:  RawGuestResources{map[string]any{"template": float64(1)}},
			output: []GuestResource{{Template: true}}},
		{name: "Type",
			input:  RawGuestResources{map[string]any{"type": "qemu"}},
			output: []GuestResource{{Type: GuestQemu}}},
		{name: "Uptime",
			input:  RawGuestResources{map[string]any{"uptime": float64(72169)}},
			output: []GuestResource{{Uptime: 72169}}},
		{name: "[]GuestResource",
			input: RawGuestResources{
				map[string]any{
					"maxcpu":    float64(10),
					"cpu":       float64(3.141592653589793),
					"diskread":  float64(1637428),
					"maxdisk":   float64(8589934592),
					"disk":      float64(0),
					"diskwrite": float64(1690811),
					"hastate":   "started",
					"vmid":      float64(100),
					"maxmem":    float64(2147483648),
					"mem":       float64(1048576),
					"name":      "test-vm1",
					"netin":     float64(23884639),
					"netout":    float64(1000123465987),
					"node":      "pve1",
					"status":    "running",
					"tags":      "tag1;tag2;tag3",
					"template":  float64(0),
					"type":      "qemu",
					"uptime":    float64(72169)},
				map[string]any{
					"maxcpu":    float64(50),
					"cpu":       float64(0.141592653589793),
					"diskread":  float64(857324),
					"maxdisk":   float64(9743424),
					"disk":      float64(23234),
					"diskwrite": float64(78347843754),
					"hastate":   "",
					"vmid":      float64(100000),
					"maxmem":    float64(946856732535),
					"mem":       float64(1342),
					"name":      "dev-vm1",
					"netin":     float64(2331323424),
					"netout":    float64(88775378423476),
					"node":      "pve2",
					"status":    "running",
					"tags":      "dev",
					"template":  float64(0),
					"type":      "lxc",
					"uptime":    float64(88678345)},
				map[string]any{
					"maxcpu":    float64(1),
					"cpu":       float64(0),
					"diskread":  float64(846348234),
					"disk":      float64(0),
					"maxdisk":   float64(56742482484),
					"diskwrite": float64(3432),
					"hastate":   "",
					"vmid":      float64(999),
					"maxmem":    float64(727345728374),
					"mem":       float64(68467234324),
					"name":      "template-linux",
					"netin":     float64(23884639),
					"netout":    float64(1000123465987),
					"node":      "node3",
					"status":    "stopped",
					"tags":      "template",
					"template":  float64(1),
					"type":      "qemu",
					"uptime":    float64(0)}},
			output: []GuestResource{
				{
					CpuCores:           10,
					CpuUsage:           3.141592653589793,
					DiskReadTotal:      1637428,
					DiskUsedInBytes:    0,
					DiskSizeInBytes:    8589934592,
					DiskWriteTotal:     1690811,
					HaState:            "started",
					ID:                 100,
					MemoryTotalInBytes: 2147483648,
					MemoryUsedInBytes:  1048576,
					Name:               "test-vm1",
					NetworkIn:          23884639,
					NetworkOut:         1000123465987,
					Node:               "pve1",
					Status:             PowerStateRunning,
					Tags:               []Tag{"tag1", "tag2", "tag3"},
					Template:           false,
					Type:               GuestQemu,
					Uptime:             72169,
				},
				{
					CpuCores:           50,
					CpuUsage:           0.141592653589793,
					DiskReadTotal:      857324,
					DiskUsedInBytes:    23234,
					DiskSizeInBytes:    9743424,
					DiskWriteTotal:     78347843754,
					HaState:            "",
					ID:                 100000,
					MemoryTotalInBytes: 946856732535,
					MemoryUsedInBytes:  1342,
					Name:               "dev-vm1",
					NetworkIn:          2331323424,
					NetworkOut:         88775378423476,
					Node:               "pve2",
					Status:             PowerStateRunning,
					Tags:               []Tag{"dev"},
					Template:           false,
					Type:               GuestLXC,
					Uptime:             88678345,
				},
				{
					CpuCores:           1,
					CpuUsage:           0,
					DiskReadTotal:      846348234,
					DiskUsedInBytes:    0,
					DiskSizeInBytes:    56742482484,
					DiskWriteTotal:     3432,
					HaState:            "",
					ID:                 999,
					MemoryTotalInBytes: 727345728374,
					MemoryUsedInBytes:  68467234324,
					Name:               "template-linux",
					NetworkIn:          23884639,
					NetworkOut:         1000123465987,
					Node:               "node3",
					Status:             PowerStateStopped,
					Tags:               []Tag{"template"},
					Template:           true,
					Type:               GuestQemu,
					Uptime:             0,
				},
			},
		},
	}
	for _, test := range tests {
		t.Run(test.name, func(*testing.T) {
			require.Equal(t, test.output, test.input.Get(), test.name)
		})
	}
}
